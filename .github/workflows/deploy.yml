name: Build and Release Cross-Platform Binaries

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
            binary_suffix: .exe
          - os: macos-12
            target: x86_64-apple-darwin
            archive: tar.gz
            binary_suffix: ''
          - os: macos-12
            target: aarch64-apple-darwin
            archive: tar.gz
            binary_suffix: ''
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.gz
            binary_suffix: ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "rust-cache-${{ matrix.target }}"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies (Linux/macOS)
        if: matrix.os != 'windows-latest'
        uses: nick-fields/retry@v2
        with:
          max_attempts: 3
          command: |
            if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
              sudo apt-get update && sudo apt-get install -y musl-tools
            fi
            if [[ "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
              rustup target add aarch64-apple-darwin
            fi

      - name: Build binary
        shell: bash
        run: |
          if [[ "${{ matrix.target }}" == "x86_64-apple-darwin" || "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
            export RUSTFLAGS="-C link-arg=-Wl,--gc-sections -C link-arg=-Wl,--icf=all"
          fi
          cargo build --release --target ${{ matrix.target }} --locked

      - name: Package binary
        id: package
        run: |
          BINARY_NAME="copilot${{ matrix.binary_suffix }}"
          ARTIFACT_NAME="copilot-${{ github.ref_name }}-${{ matrix.target }}"
          mkdir -p dist
          cp target/${{ matrix.target }}/release/$BINARY_NAME dist/
          if [[ "${{ matrix.archive }}" == "zip" ]]; then
            cd dist && zip $ARTIFACT_NAME.zip $BINARY_NAME && cd ..
            echo "artifact_path=dist/$ARTIFACT_NAME.zip" >> $GITHUB_OUTPUT
          else
            cd dist && tar -czf $ARTIFACT_NAME.tar.gz $BINARY_NAME && cd ..
            echo "artifact_path=dist/$ARTIFACT_NAME.tar.gz" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact_path }}
          path: ${{ steps.package.outputs.artifact_path }}

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.artifact_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
